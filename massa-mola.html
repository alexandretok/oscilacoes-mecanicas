<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        canvas {
            border: 2px solid grey;
            background-color: #E6F9FF;
        }
        #crate {
            display: none;
        }
    </style>
</head>
<body onload="inicializar()">
    <canvas id="canvas" width="700" height="270">
        Navegador não suporta HTML5
    </canvas>
    <img id="crate" src="crate.png">
    <script type="text/javascript">
        var canvas, imgCaixa, velocidadeAnimacao, drawInterval,  context, tempo, tempoDeAtualizacaoDoCanvas, massaAltura, massaLargura, massa, massaPosicaoX, massaPosicaoXOriginal, massaVelocidade, kMola, x0, xp, teta;

        function inicializar() {
            massaAltura = 200;
            massaLargura = 200;

            x0 = 100;   /* Posicao inicial */
            xp = 0;     /* Velocidade inicial */

            kMola = 10;
            massa = 10;

            massaPosicaoXOriginal = 400;
            massaPosicaoX = 400 + x0;

            tempoDeAtualizacaoDoCanvas = 30;
            velocidadeAnimacao = 150;
            tempo = 90;

            canvas = document.getElementById("canvas");
            context = canvas.getContext("2d");
            context.font = "bold 16px Arial";

            imgCaixa = document.getElementById("crate");

            addEventListener('keydown', keyDown);

            drawInterval = setInterval(draw, tempoDeAtualizacaoDoCanvas);
        }

        function changeValues(){
            tempo += tempoDeAtualizacaoDoCanvas/velocidadeAnimacao;
            massaPosicaoX = massaPosicaoXOriginal + Math.sin(tempo) * 100;
        }


        /* Funcao para permitir ao usuario controlar algumas caracteristicas da simulacao */
        function keyDown(e){
//            console.log(e.keyCode);
            if(e.keyCode == 32) {

                if(drawInterval){
                    clearInterval(drawInterval);
                    drawInterval = false;
                }else{
                    drawInterval = setInterval(draw, tempoDeAtualizacaoDoCanvas);
                }
            }


            if(e.keyCode == 37){
                if(velocidadeAnimacao < 400) {
                    velocidadeAnimacao += 20;
                }
            }

            if(e.keyCode == 39){
                if(velocidadeAnimacao > 60) {
                    velocidadeAnimacao -= 20;
                }
            }
            console.log(velocidadeAnimacao);
        }

        function draw(){
            context.clearRect(0, 0, canvas.width, canvas.height); /* Limpa a tela */
            context.fillRect(massaPosicaoX, canvas.height - massaAltura, massaLargura, massaAltura); /* Desenha a posicao do jogar */


            /*Desenhando a escala na parte superior*/
            /*Cada ponto na escala equivale a 100px */
            context.beginPath();
            alturaEscala = canvas.height - massaAltura - 5;
            context.moveTo(0, alturaEscala);
            context.lineTo(canvas.width, alturaEscala);
            for(i=0;i<=canvas.width;i+=100){
                context.moveTo(i, alturaEscala);
                if(i == 0)
                    back = 0;
                else if(i == canvas.width)
                    back = i - 10;
                else back = i - 5;
                context.fillText(i/100, back, alturaEscala - 10);
                context.moveTo(i, alturaEscala - 5);
                context.lineTo(i, alturaEscala + 5);
            }

            context.drawImage(imgCaixa, massaPosicaoX, canvas.height - massaAltura);

            /* Desenhando a mola */
            /* A mola possui 5 aspirais */
            xAtual = 0;
            yAtual = canvas.height - massaAltura/2;
            y0 = yAtual;
            nAspirais = 10;
            comprimentoAspiral = 7;
            deslocamentoXPixels = (massaPosicaoX - massaPosicaoXOriginal) + 100;
            deslocamentoXPorAspiral = deslocamentoXPixels/(nAspirais*2);
            deslocamentoYPorAspiral = comprimentoAspiral*comprimentoAspiral - Math.sqrt(Math.pow(deslocamentoXPorAspiral, 2));

            context.moveTo(xAtual, yAtual);
            context.lineTo(xAtual += 100, yAtual);

            deslocamentoXPorAspiral += 2;

            for(i=0;i<nAspirais/2;i++) {
                /* Desenha as espirais */
                context.lineTo(xAtual += deslocamentoXPorAspiral, yAtual += deslocamentoYPorAspiral);
                context.lineTo(xAtual += deslocamentoXPorAspiral, yAtual = y0);
                context.lineTo(xAtual += deslocamentoXPorAspiral, yAtual -= deslocamentoYPorAspiral);
                context.lineTo(xAtual += deslocamentoXPorAspiral, yAtual = y0);
            }


            /* Escrevendo informacoes do sistema */
            context.fillText("k = " + kMola + " N/m", 10, y0 - 10);
            context.fillText("m = " + massa + " kg", massaPosicaoX - 100, y0 - 10);
            context.fillText("Equação do sistema:   m۰Ẍ + K۰x = 0", 10, 25);

            context.lineTo(massaPosicaoX, yAtual);
            context.stroke();

            changeValues();
        }
    </script>
</body>
</html>